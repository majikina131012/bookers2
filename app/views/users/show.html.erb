<div class="row">
  <%= render 'books/sidebar', user: @user %>
  <div class="col-md-8 offset-md-1">
    <h2>Books</h2>
    <table class="table">
      <tr>
        <th></th>
        <th>Title</th>
        <th>Opinion</th>
        <th>Favorite</th>
        <th></th>
      </tr>
      <% @books.each do |book| %>
      <tr>
        <td>
          <%= link_to user_path(book.user.id) do %>
            <%= image_tag book.user.get_profile_image(100,100) %>
          <% end %>
        </td>
        <td>
          <%= link_to book_path(book.id) do %>
            <%= book.title %>
          <% end %>
        </td>
        <td><%= book.body %></td>
        <td>
          <% if book.favorited_by?(current_user) %>  
            <%= link_to book_favorites_path(book.id), method: :delete do %>
              <i class="fas fa-heart" aria-hidden="true" style="color: red;"></i>
              <%= book.favorites.count %>
            <% end %>
          <% else %>
            <%= link_to book_favorites_path(book.id), method: :post do %>
              <i class="fas fa-heart"></i>
              <%= book.favorites.count %>
            <% end %>
          <% end %>
        </td>
        <td> <%= link_to "#{book.book_comments.count}", book_path(book.id) %></td>
      </tr>
      <% end %>
    </table>
    <% if @user == current_user %>
        <div id="map"></div>
      <% end %>
    </div>
    <script type="text/javascript">
      function initMap() {
        var test = {
          lat: <%= @user.latitude.present? ? @user.latitude : 0 %>, 
          lng: <%= @user.longitude.present? ? @user.longitude : 0 %>
        };
        var map = new google.maps.Map(document.getElementById('map'), {
                  zoom: 15,
                  center: test
                  });
        var transitLayer = new google.maps.TransitLayer();
        transitLayer.setMap(map);

        var contentString = '住所：<%= @user.address_city %>';
        var infowindow = new google.maps.InfoWindow({
          content: contentString
        });
        var marker = new google.maps.Marker({
                      position:test,
                      map: map,
                      title: contentString
                    });

        marker.addListener('click', function() {
          infowindow.open(map, marker);
        });
      }
    </script>
    <script async defer
                  src="https://maps.googleapis.com/maps/api/js?v=3.exp&key=<%= ENV['Maps_API_Key'] %>&callback=initMap">
    </script>
    <style type="text/css">
      #map { height: 200px;
            width: 70%;}
    </style>
  </div>
</div>